![alt text](image.png)
---

## 登場人物と役割

* **クライアント（Client）**

  * 信頼できる環境（Secure Enclave等）で「生データを取得→署名」
  * それを使って「差分プライバシー化＋証明生成」を行い、結果を送信

* **シャッフラー（Shuffler）**

  * クライアントから受け取ったデータをバラバラに並べ替え、匿名化してサーバーへ中継

* **サーバー（Server）**

  * 受け取った出力と証明をチェック
  * 問題なければ統計を集計・公開

---

## 処理の流れ（全６ステップ）

1. **乱数の生成 (0)**

   * クライアントとサーバーで安全に使うランダム値を協調生成

2. **データの署名 (1→2)**

   * 信頼環境で生データ x を秘密鍵でサイン → (x, σₓ)

3. **差分プライバシー化＋証明 (2)**

   * (x, σₓ) と乱数 ρ を使い、プライバシー化した値 ẋ とゼロ知識証明 π を作成

4. **送信 (3)**

   * (ẋ, π) をシャッフラーへ送る
   * ※ローカルモデルでは直接サーバーへ

5. **並べ替え (4→5)**

   * シャッフラーで n 件の (ẋ, π) をシャッフルしてサーバーに中継

6. **検証・集計 (5→6)**

   * サーバーが π の正当性を検証 → 問題なければ ẋ を受理
   * 最後に全件を集計して結果を公開

---

### 「ローカルモデル」と「シャッフルモデル」の違い

* **ローカルモデル**

  * ステップ4（シャッフル）を省略し、直接サーバーへ送信
* **シャッフルモデル**

  * ステップ4 でデータを混ぜることで、誰のデータか分からないようにする

---
VLDPPipeline の主要フロー

```mermaid
sequenceDiagram
    autonumber
    participant S as サーバー
    participant CU as クライアント i<br>（Untrusted）
    participant CT as クライアント i<br>（Trusted Enclave）
    participant Sh as シャッフラー

    %% ステップ0: 乱数の相互生成
    S->>CU: 0.1 乱数シード要求
    CU->>S: 0.2 部分乱数応答
    Note over S,CU: 共通乱数シード生成

    %% ステップ1→2: データの署名取得
    CU->>CT: 1. 元データ要求
    CT->>CU: 2. 署名付きデータ

    %% ステップ3: LDP＋NIZK生成
    CU->>CU: 3. LDP処理＆NIZK証明生成
    Note over CU: 署名付きデータにノイズ付与＋証明作成

    %% ステップ4: シャッフラーへ送信
    CU->>Sh: 4. DP出力＋NIZK証明

    %% ステップ4（継続）: シャッフル
    Sh->>Sh: 4.x n 件をランダム並べ替え
    Sh->>S: 4.y シャッフル済みDP出力＋NIZK証明

    %% ステップ5→6: サーバーで検証・集計
    S->>S: 5. 各 NIZK 証明検証
    S->>S: 6. DP 出力抽出・集計
    S->>S: 7. 結果公開
```

---

### 各ステップ対応

1. **ステップ0（乱数相互生成）**
   サーバーとクライアントがそれぞれ部分的な乱数をやり取りし、共通の乱数シードを安全に確定。

2. **ステップ1→2（署名付きデータ取得）**
   Trusted Enclave が元データを読み取り、秘密鍵で署名。アン・トラストド環境はその署名付きデータのみ受領。

3. **ステップ3（LDP＋NIZK証明生成）**
   アン・トラストド環境でローカル差分プライバシー処理（ノイズ付与）を行い、非対話型ゼロ知識証明を同時生成。

4. **ステップ4（シャッフル）**
   各クライアントから送られた DP 出力と証明をシャッフラーがランダムに並べ替え、順序の匿名化を強化。

5. **ステップ5（証明検証）**
   サーバー側で NIZK 証明を検証し、不正なものは排除。

6. **ステップ6→7（集計・公開）**
   検証済みの DP 出力を集計し、最終的な統計結果を公開。

この図をベースに、さらにデプロイ時のメッセージ詳細や例外フロー（不正検出時の排除など）を追加していただくと、より実装に近いシーケンス図が完成します。
