---
marp: true
theme: default
mermaid: true
paginate: true
title: CMS資料
author: 村瀬
date: 2025-05-016
style: |
  /* スライド全体の背景色と文字色 */
  section {
    background-color: #f5f5f5;
    color:rgb(47, 15, 224);
  }
  
  /* Mermaid 図内の文字色や背景色を調整 */
  .mermaid {
    /* Mermaid 図自体のスタイルをここで調整可能 */
    color: #333333;
        # transform: scale(0.7);

  }

  .mermaid .node text,
  .mermaid .edgeLabel text {
    font-size: 14px;
  }

section.title h1,
section.title h3,
section.title h6 {
  color: white;
}
---
<!-- ---
marp: true
theme: default
paginate: true
headingDivider: 2
_class: lead
--- -->
# VLDPPipeline の要点

- **目的**：ローカル差分プライバシー (LDP) で露呈する *入力操作攻撃*・*出力操作攻撃* を暗号学的に防ぎつつ，ローカルモデル／シャッフルモデル両方で効率良く検証可能にする

- **結果**：クライアント実行 < 2 s，サーバ検証 5–7 ms/クライアントで完了する実装を報告。

--- 
## この論文の新規性

1. **初の効率的なVLDPスキーム in シャッフルモデル**
   * これまでVLDPはローカルモデルのみでの構成例が知られており、**シャッフルモデル向けの暗号的検証スキームは存在しなかった** 
2. **真正性と匿名性の相反解消**
   * **入力真正性**（署名付き入力）と**レポートの匿名性**（シャッフル後のunlinkability）は相反する要件ですが、両立を実現するために「クライアント識別情報をすべて証明の秘密部に移動」する設計を導入
3. **ワンショット対話のみ**
   * 乱数シード登録と署名交換は一度だけ行い、その後は各レポートに対して対話を不要とすることで、クライアント・サーバー双方の**通信量とレイテンシを最小化**しています 


--- 

# 3 章 Preliminaries — 構成要素

<!-- --- 
## システム全体フロー

1. **乱数シードの安全共有**  
2. **Trusted Enclave で生データ取得＋署名**  
3. **アン・トラスト領域で LDP 処理 & NIZK 生成**  
4. **シャッフラーが順序をランダム化**  
5. **サーバが NIZK を検証し，正当な出力だけ集計**  
6. **集計結果を公開**  
**用語補足**

* **PRF** は “鍵付きハッシュ” の一種で、入力にランダム性が見えない値を返す擬似乱数関数です ([Cryptography Stack Exchange][1])。
* **PRG** は PRF を繰り返し呼び出して長い擬似乱数列を作る仕組みです ([Cryptography Stack Exchange][1])。
* **Trusted Enclave（TEE）** は CPU 内の隔離領域で、外部 OS から隠したまま鍵と機密計算を守るハードウェア機構です ([ウィキペディア][2], [Microsoft Learn][3])。 -->



<!-- 
### コミットメント： 採用プリミティブ:  **Pedersen ベクトルコミットメント**  -->
### コミットメント
* **用途**: クライアントは乱数鍵 $k_c$ を先にコミットしてから開示し、後からの値の差し替えを防ぎます。


### デジタル署名：採用プリミティブ: **Schnorr 署名**
* **用途**: 秘密鍵で入力 \(x\) || 時刻に署名して入力真正性を示す


### NIZK-PK (zk-SNARK)**採用プリミティブ**: **Groth16 zk-SNARK**
* **用途**: クライアントは「Pedersen＋署名＋LDP 処理の正当性」を約 200 B の証明で提出し、サーバは１回のペアリングで検証します。
* **特性と採用メリット**: 証明が小さく通信負荷が低い、検証はミリ秒級で高スループット；trusted setup を要しますがサーバを準信頼とする前提で許容するらしい


### 疑似乱数生成 (PRG from PRF)  
- PRF からビット列を連結して乱数列を得る標準的手法。\
  LDP ノイズやシャッフル順序を再現可能にする。
* **採用プリミティブ**: 鍵付き **BLAKE2s** を PRF として直接乱数列に展開します ([Cryptology ePrint Archive][4])。
* **簡単流れと数式**: クライアント鍵 $k_c$ とサーバ鍵 $k_s$ を XOR して共通鍵 $k$ を得て、ラウンド識別子 $s_j$ と結合し $\rho_{i,j}= \text{BLAKE2s}(k‖s_j)$ を計算します。
* **用途**: 生成した $\rho_{i,j}$ を LDP ノイズとメッセージのシャッフル順のタネに用います。
* **特性と採用メリット**: BLAKE2s は 128-bit 相当の安全性と高速実装が知られ、同じ関数で PRF とハッシュを兼用できコードが軽くなります ([tosc.iacr.org][5])。




---

<!-- ## 他方式との比較

| 方式 | 入力操作攻撃 | 出力操作攻撃 | シャッフルモデル | 互換乱数化 | 交互回数 |
|------|--------------|--------------|-----------------|-----------|---------|
| **VLDPPipeline** | ✔（署名） | ✔（NIZK） | ✔ | 汎用 | **1** |
| Kato et al. ‘21 | ✖ | ✔ | ✖ | 𝑘-RR, OUE | 多 |
| Song et al. ‘23 | ✖ | ✔ | ✖ | 𝑘-RR, OUE | 多 |
| Cheu et al. ‘19 (攻撃例) | 攻撃可能 | 攻撃可能 | ✖ | 汎用 | n/a |

- LDP は少数の不正クライアントで統計を崩壊させ得ることが実証済み
- 既存の「検証付き LDP」は出力のみを対象にし，入力の真正性は未保証
- VLDPPipeline はそれらを同時に満たす初のスキーム
--- -->

# 5 章 脅威モデル

### クライアント  
- プログラムは**完全に悪意的**＋相互に共謀可。  
- ただし Trusted Enclave 内部は改竄不能
### サーバ  
- **セミホーネスト**（正規手順は守るが推測は最大化）。  
### シャッフラー  
- **Honest-but-curious** な非協力第三者。実装は mixnet 等を想定

### ⬆シャッフラーもサーバ  も「正規手順を守るが、入出力の中身を全部保存してあとで解析する」モデル
---
### 役割ごとの前提

| アクター      | 想定                                   | なぜその設定か                              |
| ---------- | ------------------------------------ | ------------------------------------ |
| **クライアント** | **悪意的**・相互に共謀可                    | 少数の不正者でも統計を歪め得るため，最悪ケースを想定           |
| **サーバー**   | **セミホーネスト**（手順通りだが推測は行う）             | 大規模集計役を単純化し，TEE＋署名/NIZK による検証で安全性を担保 |
| **シャッフラー** | **honest-but-curious**（Mixnet ノード相当） | 出力経路を隠してプライバシー増幅を狙うが，データ改竄はしない前提     |
| **ネットワーク** | 盗聴可能・改竄不可能 (TLS 等)                   | 暗号チャネルは敷設済みと仮定                       |


---
**【セミホーネストモデルの具体例】**

* **サーバー**：大手ブラウザ企業やモバイル OS 提供社が統計集計サーバーを運営

  * プロトコル通りに DP 出力・証明を検証し集計するが、受動的に個別情報を解析しようとする
* **シャッフラー**：独立監査機関やオープンコンソーシアムがミックスノードを提供

  * メッセージを必ず並べ替えて転送するが、タイミングやパターンからメタデータを読み取ろうとする

---
### 【残存脅威】

1. **送信時間や大きさからバレる**

   * 深夜だけ送れば「夜に活動する人」とわかるなど、時刻やメッセージの大きさだけで本人を推測される可能性。

2. **サーバーとシャッフラーが手を組む**
   * 2者がログ（並び順・時刻）を突き合わせると「誰がどのデータか」を推定可
3. **少人数データでバレる**
   * 人数が少ない地域や珍しい属性だけの集計は、推定されやすい。

> **追加対策の例**
> ・送信タイミングをランダムにずらす
> ・シャッフラーを複数経由にする
> ・ノイズ（ε, δ）の強さを上げる など

<!-- 
**【 残存脅威】**

  1. **メタデータ解析による利用者推定**
     * 提出タイミングの微妙な偏り（例：深夜帯だけに送信）やメッセージ長から、特定ユーザーの行動パターンを部分的に再識別され得る
  2. **シャッフラー⇄サーバー間の共謀（Collusion）**

     * 両者が内部ログ（配送順序やタイムスタンプ）を突き合わせると、シャッフル前後で送信元がリンクされ、匿名性が弱まる恐れ
  3. **パッシブ解析での統計的推測**

     * 小規模ユーザー群や希少属性を含む集団の統計を見ることで、その集団に属する個人の属性を逆推定されるリスク
  4. **マリシャス攻撃への無防備性**

     * 完全なプロトコル逸脱（偽メッセージ挿入やデータ削除）を行う「悪意あるサーバー」には別途対策が必要

> **ポイント**：
>
> * honest-but-curious モデルでは「仕様は守るが内部情報を解析する」攻撃を阻止できないため、これらの脅威には追加の対策（タイミング乱し、マルチシャッフラー、差分プライバシーパラメータの調整など）が求められます。 -->


### 補足：Mixnet と Trusted Enclave

**Mixnet ノード群（ミックスネットワーク）とは**
「分散シャッフル＋復号」を繰り返すことで、通信パターンやメッセージ内容から送信者を切り離し、高い匿名性を実現する仕組み
* **役割**：送信者から届いた暗号化メッセージを複数のサーバー（ノード）で順番に受け取り、各ノードが「受け取ったメッセージ群をランダムに並べ替えて」「再暗号化」、次のノードに送ることで送信元と送信先を切り離し、匿名性を強化する分散ネットワークです。
* **仕組み**：

  1. 送信者はメッセージを複数のノードに対応する鍵で多重に暗号化（レイヤー状に）
  2. 第１ノードは最外層を復号し、バッファにためた全メッセージをシャッフル
  3. 第２ノード以降も同様に復号→シャッフルを繰り返し、最後のノードが宛先に配信
* **匿名化の要点**：各ノードは自分が受け取ったパケットの送信元だけを知り、最終的な宛先はわからないため、入力と出力がリンクされにくい。
* **代表例・用途**：

  * **Mixminion／Mixmaster**：匿名メール送信システム
  * **Loopix**：リアルタイム通信向けの低レイテンシ Mixnet
  * **I2P**：匿名 P2P 通信ネットワークの一部として利用
* **VLDPPipeline での位置付け**：シャッフラーは “１段の Mixnet ノード” として機能し、クライアント→サーバー間のメッセージの順序匿名化を担います。

* **Trusted Execution Environment (例 Intel SGX)** は CPU 内に暗号化されたエンクレーブを設け，OS さえ触れない形で鍵と生データを保持・計算できる。入力真正性の署名鍵をここに格納し，外部ロジックを悪意的にしても鍵漏えいを防ぎます。

---
## プロトコルの図
- 任意の数(今回はn)のCLientと　Shuffler　Serverが一つずついる
- どうやら最初に乱数を生成してる
![alt text](image.png)

---

## 登場人物と役割

* **クライアント（Client）**

  * 信頼できる環境（Secure Enclave等）で「生データを取得→署名」
  * それを使って「差分プライバシー化＋証明生成」を行い、結果を送信

* **シャッフラー（Shuffler）**

  * クライアントから受け取ったデータをバラバラに並べ替え、匿名化してサーバーへ中継

* **サーバー（Server）**

  * 受け取った出力と証明をチェック
  * 問題なければ統計を集計・公開

---
# 処理の流れ（全６ステップ）

1. **乱数の協調生成 (ステップ 0)**

   * クライアントとサーバーが鍵を出し合い、後で使う共通乱数 **ρ (ロー)** を安全に作る。

     * **ρ** : この後のノイズやシャッフル順を決める乱数シード。

2. **データの署名 (ステップ 1→2)**

   * クライアントの信頼環境（TEE）が生データ **x** に秘密鍵で署名し、対になる署名 **σₓ** を付ける。

     * **x** : ユーザーの元データ。
     * **σₓ** : x が本物であることを示すデジタル署名。
---
3. **プライバシー化＋証明生成 (ステップ 2)**

   * x と ρ を使ってノイズ付与したデータ **ẋ (ティルダ x)** を作り、
   * その手続きが正しいと示すゼロ知識証明 **π (パイ)** を生成する。

     * **ẋ** : 差分プライバシー(LDP)済みのデータ。
     * **π** : 「確かにルール通りにノイズを足した」ことを示す証明。

4. **送信 (ステップ 3)**

   * (ẋ, π) を **シャッフラー**へ送る。
   * ※ローカルモデルの場合はシャッフラーを経由せず直接サーバーへ送る。
---
5. **並べ替え (ステップ 4→5)**

   * シャッフラーが n 件の (ẋ, π) をランダム順に並べ替え、まとめてサーバーへ

     * **n** : 参加クライアントの総数。

6. **検証・集計 (ステップ 5→6)**

   * サーバーが各 π を検証し、正しければ対応する ẋ を受理。
   * 全クライアント分の ẋ を集計し、最終統計を公開。



<!-- ---

論文の実験は大きく **2 段階** に分かれています。


## 1. 実データを用いた「現実的ユースケース」評価

### データセット
| 目的       | データ                           | 前処理                          | LDPアルゴリズム                   | 目標統計           |
| -------- | ----------------------------- | ---------------------------- | --------------------------- | -------------- |
| 位置ヒストグラム | Microsoft GeoLife GPS (182 人) | 1 日5 件×5 日分のGPSを郵便番号8 区分に集約  | 𝑘-ary RR (𝑘 = 8)          | 各日・各郵便番号の人数分布  |
| 電力平均値    | London Smart-Meter (5,567 世帯) | 直近5 日分の家庭平均を最大値6.928 kWhで正規化 | Real-valued LDP (精度𝑘 = 10) | 各日の平均電力消費      |
---
### 評価対象

同論文が提案する 3 スキーム

* **Base**　…毎タイムステップごとに乱数生成
* **Expand** …乱数を拡張して共有、通信量を削減
* **Shuffle** …シャッフルモデル対応・最小通信量

### 指標

* クライアント／サーバーそれぞれの計算時間
* 送受信バイト数
* zk-SNARK（Groth16）の証明サイズ・検証鍵サイズ・制約数&#x20;

### 結果（T = 5 日、中央値）

* **クライアント時間**

  * Randomize: 0.61–1.80 s（GPS）/ 0.62–1.82 s（電力）
* **サーバー検証時間** 2.5–4.4 ms/レコード
* **通信量（クライアント→サーバー）**

  * Base: 2,125 B
  * Expand: 1,864 B
  * Shuffle: **1,064 B** と最小&#x20;
* **証明鍵サイズ** 最大でも53 MB（Shuffle）で、セットアップ時に配布可能&#x20;

---

## 2. 合成データによるスケーラビリティ評価

パラメータを人工的に拡大し、性能曲線を取得。

| 変更点                         | 観測結果                                                      |              |                                                           |
| --------------------------- | --------------------------------------------------------- | ------------ | --------------------------------------------------------- |
| 乱数長                         | ρ                                                         | 32 B→1,024 B | 乱数長に比例して制約数・計算時間がほぼ線形増。Shuffle でも 1,024 B で ≈8 s と実用範囲内。  |
| Merkle 木深さ d\_MT (Expand 用) | d\_MT を 4→10 に増やすと GenRand は指数増だが、Randomize は約 2 s で頭打ち。  |              |                                                           | -->


<!-- 

### まとめ

* **現実データ実験**で「1 レコードあたりクライアント < 2 s／サーバー ≈ 5 ms」の高効率を確認。
* **Shuffle スキーム**は通信量を最少化しつつシャッフルモデルのプライバシ強化を達成。
* **スケーラビリティ実験**でランダムネスやタイムステップを大幅に増やしても線形～準線形で伸びることを確認。

つまり論文は、提案手法が **実デプロイ可能な速度・通信コスト** で動作し、パラメータを拡大しても破綻しないことを一連の実験で示しています。 -->

<!-- ---
### だれが“何を見られて” だれが“何を見られない”か

*(シャッフラー＝「並べ替えるだけの係」、サーバー＝「検証して集計する係」)*

| 観測できるもの               | **シャッフラー**<br>（出口に送る前の段階）      | **サーバー**<br>（シャッフル後を受信）                |
| --------------------- | ------------------------------ | -------------------------------------- |
| **到着時刻**              | ✔ 受信時刻は自分のログに残る                | ✔ 自分に届いた時刻だけを記録<br>✖ シャッフラー側の受信時刻は知らない |
| **送信元 IP などネットワーク情報** | ✔ クライアントの IP / TCP 接続情報を一瞬だけ見る | ✖ シャッフラーからしか来ないので個別 IP は見えない           |
| **パケット長・外形サイズ**       | ✔ そのまま見える                      | ✔ シャッフラーから来た後の長さはわかる                   |
| **中身（DP 出力＋NIZK 証明）** | ✔ 見える＊<br>※元データは既にノイズ付き        | ✔ 見える（検証もここで実行）                        |
| **「このメッセージは誰のか」**     | ✖ 順序を崩して出すので自分でも分からなくなる        | ✖ IP も順序情報も無いので単独では結び付けられない            |

> \* VLDPPipeline では中身は暗号化せず送っても差分プライバシー済みなので情報漏えいは限定的、という設計例です。必要なら暗号化して **シャッフラーには長さしか見せない** 実装も可。 -->

---

   ```
   シャッフラーのログ例
   10:00:02 ①(IP_A, 512byte)
   10:00:03 ②(IP_B, 520byte)
   10:00:05 ③(IP_C, 508byte)
   …（ここで順序をランダムに）…
   10:00:06 → サーバーへ送信 (512B)
   10:00:07 → サーバーへ送信 (520B)
   10:00:08 → サーバーへ送信 (508B)
   ```

   ```
   サーバーのログ例
   10:00:06 ①'(512B)
   10:00:07 ②'(520B)
   10:00:08 ③'(508B)
   ```

 **共謀すると？**

   * シャッフラーが「最初に送った 512B は IP\_A のメッセージ」と暴露。
   * サーバーは 10:00:06 に届いた 512B を照合し、「①'＝A」と復元。
   * この照合を全メッセージで行えば、“並べ替え前後” が 1 対 1 で対応し匿名性が失われる。
---

### それぞれ「わかる／わからない」

* **シャッフラー**

  * *わかる*：クライアント側ネットワーク情報、到着順序。
  * *わからない*：最終的にサーバーがどの順序で受信したか。

* **サーバー**

  * *わかる*：検証済みデータの中身、サーバー側での到着順序。
  * *わからない*：どの IP がどのメッセージを送ったか、シャッフラー受信順序。
* **協力（ログ突き合わせ）すると**「順序＋サイズ＋時刻」が合致し、誰のデータか紐付けられる危険が残る。

> **防御策のイメージ**
>
> * シャッフラーを **複数段** にして 1 段でも協力しなければ安全。
> * **バッチ転送**や **固定サイズパディング** で時刻・サイズ手掛かりを潰す。
